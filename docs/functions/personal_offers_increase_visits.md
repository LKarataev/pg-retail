### **fnc_personal_offers_increase_visits** - функция определяющая предложения, ориентированные на рост частоты визитов

Параметры функции:
- первая и последняя даты периода
- добавляемое число транзакций
- максимальный индекс оттока
- максимальная доля транзакций со скидкой (в процентах)
- допустимая доля маржи (в процентах)

##### Определение условия предложения

1. **Определение периода.** Пользователь вручную задает период действия разрабатываемого предложения, указывая первую и конечную его даты.

2. **Определение текущей частоты посещений клиента в заданный период.**
   Из конечной даты заданного периода вычитается первая дата,
   после чего полученное значение делится на среднюю интенсивность транзакций клиента (поле `Customer_Frequency` [таблицы Клиенты](#представление-клиенты)).
   Итоговый результат сохраняется в качестве базовой интенсивности транзакций клиента в течение заданного периода.

3. **Определение транзакции для начисления вознаграждения.**
   Система определяет порядковый номер транзакции в рамках заданного периода, на которую должно быть начислено вознаграждение.
   Для этого значение, полученное на шаге 2, округляется согласно арифметическим правилам до целого,
   после чего к нему добавляется число транзакций, заданное пользователем.
   Итоговое значение является целевым количеством транзакций, которое должен совершить клиент для получения вознаграждения.

##### Определение вознаграждения

4.  **Определение группы для формирования вознаграждения.** Для
    формирования вознаграждения выбирается группа, отвечающая
    последовательно следующим критериям:

    -  Индекс востребованности группы – максимальный из всех возможных.

    -  Индекс оттока по данной группе не должен превышать заданного пользователем значения. В случае, если коэффициент оттока превышает
       установленное значение, берется следующая по индексу
       востребованности группа;

    -  Доля транзакций со скидкой по данной группе – менее заданного пользователем значения. В случае, если для выбранной группы превышает
       установленное значение, берется следующая по индексу
       востребованности группа, удовлетворяющая также критерию по
       оттоку.

5.  **Определение максимально допустимого размера скидки для
    вознаграждения.** Пользователь вручную определяет долю маржи (в
    процентах), которую допустимо использовать для предоставления
    вознаграждения по группе. Итоговое значение максимально допустимой
    скидки рассчитывается путем умножения заданного значения на среднюю
    маржу клиента по группе.

6.  **Определение величины скидки.** Значение, полученное на шаге 5,
    сравнивается с минимальной скидкой, которая была зафиксирована для
    клиента по данной группе, округленной вверх с шагом в 5%. В случае,
    если минимальная скидка после округления меньше значения,
    получившегося на шаге 5, она устанавливается в качестве скидки для
    группы в рамках предложения для клиента. В противном случае данная
    группа исключается из рассмотрения, и для формирования предложения
    для клиента процесс повторяется, начиная с шага 4 (используются
    следующая подходящая по описанным критериям группа).

Вывод функции:

| **Поле**                      | **Название поля в системе** | **Формат / возможные значения**            | **Описание**                                                                               |
|-------------------------------|-----------------------------|--------------------------------------------|--------------------------------------------------------------------------------------------|
| Идентификатор клиента         | Customer_ID                 |                                            |                                                                                            |
| Дата начала периода           | Start_Date                  | гггг-мм-ддTчч:мм:сс.0000000                | Дата начала периода, в течение которого необходимо совершить транзакции                    |
| Дата окончания периода        | End_Date                    | гггг-мм-ддTчч:мм:сс.0000000                | Дата окончания периода, в течение которого необходимо совершить транзакции                 |
| Целевое количество транзакций | Required_Transactions_Count | Арабская цифра (десятичная дробь)          | Порядковый номер транзакции, на которую начисляется вознаграждение                         |
| Группа предложения            | Group_Name                  |                                            | Название группы предложения, на которой начисляется вознаграждение при выполнении условия. |
| Максимальная глубина скидки   | Offer_Discount_Depth        | Арабская цифра (десятичная дробь), процент | Максимально возможный размер скидки для предложения                                        |

