### fnc_personal_offers_increase_avg_check_plpgsql - функция, определяющая предложения, ориентированные на рост среднего чека

Параметры функции:
- метод расчета среднего чека (1 - за период, 2 - за количество)
- первая и последняя даты периода (для 1 метода)
- количество транзакций (для 2 метода)
- коэффициент увеличения среднего чека
- максимальный индекс оттока
- максимальная доля транзакций со скидкой (в процентах)
- допустимая доля маржи (в процентах)

##### Определение условия предложения

1.  **Выбор метода расчета среднего чека.** Существует возможность
    выбора метода расчета среднего чека – за определенный период времени
    или за определенное количество последних транзакций. Метод расчета
    *вручную определяется* пользователем.

    1.  Пользователь выбирает методику расчета **по периоду**, после чего
        указывает первую и последнюю даты периода, за который
        необходимо рассчитать средний чек для всей совокупности
        клиентов, попавших в выборку. При этом последняя дата
        указываемого периода должна быть позже первой, а указанный
        период должен быть внутри общего анализируемого периода. В
        случае указания слишком ранней или слишком поздней даты
        система автоматически подставляет дату, соответственно, начала
        или окончания анализируемого периода. Для расчета учитываются
        все транзакции, совершенные каждым конкретным клиентом в
        течение заданного периода.

    2.  Пользователь выбирает методику расчета **по количеству последних
        транзакций**, после чего вручную указывает количество
        транзакций, по которым необходимо рассчитать средний чек. Для
        расчета среднего чека берется заданное пользователем
        количество транзакций, начиная с самой последней в обратном
        хронологическом порядке. В случае, если каким-либо клиентом из
        выборки за весь анализируемый период совершено меньше
        указанного количества транзакций, для анализа используется
        имеющееся количество транзакций.

2.  **Определение среднего чека.** Для каждого клиента определяется
    текущее значение его среднего чека согласно выбранному в рамках шага
    1 методу. Для этого общий товарооборот по всем попавшим в выборку
    транзакциям клиента делится на количество этих транзакций. Итоговое
    значение сохраняется в таблице как текущее значение среднего чека.

3.  **Определение целевого значения среднего чека.** Рассчитанное
    значение среднего чека умножается на коэффициент заданный пользователем. Получившееся значение сохраняется в системе
    как целевое значение среднего чека клиента и в дальнейшем
    используется для формирования условия предложения, которое должен
    выполнить клиент для получения вознаграждения.

##### Определение вознаграждения

4.  **Определение группы для формирования вознаграждения.** Для
    формирования вознаграждения выбирается группа, отвечающая
    последовательно следующим критериям:

    -   Индекс востребованности группы – максимальный из всех возможных.

    -   Индекс оттока по данной группе не должен превышать заданного пользователем значения. В случае, если коэффициент оттока превышает
        установленное значение, берется следующая по индексу
        востребованности группа;

    -   Доля транзакций со скидкой по данной группе – менее заданного пользователем значения. В случае, если для выбранной группы превышает
        установленное значение, берется следующая по индексу
        востребованности группа, удовлетворяющая также критерию по
        оттоку.

5.  **Определение максимально допустимого размера скидки для
    вознаграждения.** Пользователь вручную определяет долю маржи (в
    процентах), которую допустимо использовать для предоставления
    вознаграждения по группе. Итоговое значение максимально допустимой
    скидки рассчитывается путем умножения заданного значения на среднюю
    маржу клиента по группе.

6.  **Определение величины скидки.** Значение, полученное на шаге 5,
    сравнивается с минимальной скидкой, которая была зафиксирована для
    клиента по данной группе, округленной вверх с шагом в 5%. В случае,
    если минимальная скидка после округления меньше значения,
    получившегося на шаге 5, она устанавливается в качестве скидки для
    группы в рамках предложения для клиента. В противном случае данная
    группа исключается из рассмотрения, и для формирования предложения
    для клиента процесс повторяется, начиная с шага 4 (используются
    следующая подходящая по описанным критериям группа).

Вывод функции:

| **Поле**                       | **Название поля в системе** | **Формат / возможные значения**            | **Описание**                                                                               |
|--------------------------------|-----------------------------|--------------------------------------------|--------------------------------------------------------------------------------------------|
| Идентификатор клиента          | Customer_ID                 |                                            |                                                                                            |
| Целевое значение среднего чека | Required_Check_Measure      | Арабская цифра (десятичная дробь)          | Целевое значение среднего чека, необходимое для получения вознаграждения                   |
| Группа предложения             | Group_Name                  |                                            | Название группы предложения, на которой начисляется вознаграждение при выполнении условия. |
| Максимальная глубина скидки    | Offer_Discount_Depth        | Арабская цифра (десятичная дробь), процент | Максимально возможный размер скидки для предложения                                        |

